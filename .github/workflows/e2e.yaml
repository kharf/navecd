# AUTOGENERATED - DO NOT EDIT

name: E2E
"on":
  workflow_dispatch: null
  push:
    branches:
      - main
    tags-ignore:
      - '*'
jobs:
  Prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout E2E Repository
        uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.PAT }}
          repository: kharf/navecd-e2e
          path: ./e2e
      - name: Clean
        working-directory: ./e2e
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: gh repo deploy-key list --json id -q '.[].id' | xargs -I {} gh repo deploy-key delete {}
  E2E:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.PAT }}
          ref: ${{ github.head_ref || github.ref_name }}
      - uses: actions/setup-go@v5.5.0
      - uses: cue-lang/setup-cue@v1.0.0
      - name: Create Kubernetes Cluster
        uses: helm/kind-action@v1.12.0
        id: kind
        with:
          cluster_name: ${{ matrix.cluster.name }}
          node_image: ${{ matrix.cluster.image }}
          registry: true
          registry_name: navecdregistry
          registry_port: 5001
          registry_enable_delete: true
      - name: Build
        uses: dagger/dagger-for-github@8.0.0
        with:
          call: build --source=. export --path=./dist
      - name: Publish locally
        run: |-
          mv ./dist/cli_linux_amd64_v1/navecd /usr/local/bin/navecd
          export CUE_REGISTRY=${{ steps.kind.outputs.LOCAL_REGISTRY }}+insecure
          echo "CUE_REGISTRY=$CUE_REGISTRY" >> "$GITHUB_ENV"
          cd schema
          cue mod publish v0.0.0-dev
          cd ..
          docker build . -t ${{ steps.kind.outputs.LOCAL_REGISTRY }}/navecd:0.0.0-dev
          docker push ${{ steps.kind.outputs.LOCAL_REGISTRY }}/navecd:0.0.0-dev
      - name: Checkout E2E Repository
        uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.PAT }}
          repository: kharf/navecd-e2e
          path: ./e2e
      - name: Switch branch
        working-directory: ./e2e
        run: |-
          git switch -c ${{ matrix.cluster.name }}
          git push -u origin ${{ matrix.cluster.name }}
      - name: Init Navecd
        working-directory: ./e2e
        run: navecd init github.com/kharf/navecd-e2e --image=${{ steps.kind.outputs.LOCAL_REGISTRY }}/navecd
      - name: Install Navecd
        working-directory: ./e2e
        run: navecd install -u git@github.com:kharf/navecd-e2e.git -t ${{ secrets.E2E_TOKEN}} -b ${{ matrix.cluster.name }} --name ${{ matrix.cluster.name }}
      - name: Test Installation
        run: go test -v ./tests/e2e/ -run TestInstallation -count=1
      - name: Navecd Logs
        if: always()
        run: kubectl logs -n navecd-system deploy/project-controller-primary
      - name: Navecd describe
        if: always()
        run: kubectl describe -n navecd-system deploy/project-controller-primary
    needs: Prepare
    strategy:
      fail-fast: false
      matrix:
        cluster:
          - name: latest
            image: kindest/node:v1.33.1@sha256:050072256b9a903bd914c0b2866828150cb229cea0efe5892e2b644d5dd3b34f
          - name: previous
            image: kindest/node:v1.32.5@sha256:e3b2327e3a5ab8c76f5ece68936e4cafaa82edf58486b769727ab0b3b97a5b0d
          - name: legacy
            image: kindest/node:v1.31.9@sha256:b94a3a6c06198d17f59cca8c6f486236fa05e2fb359cbd75dabbfc348a10b211
permissions: read-all
